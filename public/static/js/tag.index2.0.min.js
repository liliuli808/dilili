(function($){function customReport(name,ops){if(window.spmReportData){var obj=ops?ops:name;window.spmReportData[name]=obj}}var APIConfig={base:"//api.bilibili.com/x/tag/",list:{tags:"archive/tags",add:"archive/add",del:"archive/del",subscribe:"subscribe/add",unsubscribe:"subscribe/cancel",like:"archive/like2",hate:"archive/hate2",report:"archive/report"}};var Tools={filterString:function(str){var re=/select|update|delete|truncate|join|union|exec|insert|drop|count|’|"|;|>|<|%/i;return re.test(str)?false:true},substitute:function(str,object){return str.replace(/\\?\{([^}]+)\}/g,function(match,name){if(match.charAt(0)=="\\")return match.slice(1);return object[name]!=undefined?object[name]:""})}};var Level={l1:4,l2:3,l3:1,l4:1};var TagAdmin={todo:function(callback){UserStatus.isLogin()?callback():biliQuickLogin(function(){location.reload()})},del:function(callback,obj){var the=this;this.todo(function(){if(the.isUp()){callback();return}if(UserStatus.level()>=Level.l1){callback()}else{(new MessageBox).show(obj,"升级到LV4就能删除标签啦~",1e3,"info")}})},add:function(callback,obj){var the=this;this.todo(function(){if(the.isUp()){callback();return}if(UserStatus.level()>=Level.l2){callback()}else{(new MessageBox).show(obj,"升级到LV3就能添加标签啦~",1e3,"info")}})},report:function(callback,obj){var the=this;this.todo(function(){if(the.isUp()){callback();return}if(UserStatus.level()>=Level.l3){callback()}else{(new MessageBox).show(obj,"升级到LV1就能举报啦~",1e3,"info")}})},topOrTread:function(callback,obj){var the=this;this.todo(function(){if(the.isUp()){callback();return}if(UserStatus.level()>=Level.l4){callback()}else{(new MessageBox).show(obj,"升级到LV1就能顶/踩啦~",1e3,"info")}})},isUp:function(){return parseInt(window.uid)===parseInt(window.mid)}};var Store={tagList:[],isOpenInfo:false,msgTime:1500,currentIndex:0,isOver:false};var TagArea={container:$(".s_tag"),domUl:$("<ul class='tag-area clearfix'></ul>"),domNothing:$("<div class='nothing'>快来成为第一个添加标签的人吧~</div>"),domBtnAdd:$("<a class='btn-add'><span class='one'></span><span class='two'></span></a>"),domIpt:$("<div class='ipt'><input type='text' placeholder='按回车键完成输入'><a class='btn-close'></a><div class='tips'>标签字数超出限制</div></div>"),domLink:$("<div class='btn-view-tag'>"+"<a class='btn-view-mod' href='#' target='_blank'>查看标签修改记录</a>"+"<span>|</span>"+"<a class='btn-view-user' href='#' target='_blank'>查看标签使用说明</a>"+"</div>"),state:{isInput:false,currentTag:null,isFirst:false},createTagList:function(){this.clearTagList();var len=Store.tagList.length;for(var i=0;i<len;i++){var tag=Store.tagList[i];var tpl=$("<li class='tag' data-index='"+i+"' data-tagid='"+tag.tag_id+"'><a href='//search.bilibili.com/all?keyword="+encodeURIComponent(tag.tag_name)+"&from_source=video_tag' target='_blank'>"+tag.tag_name+"</a></li>");if(i===0&&this.state.isFirst){tpl.hide().fadeIn()}tpl.prependTo(this.domUl)}this.domLink.show();this.domNothing.hide()},clearTagList:function(){this.domUl.find(".tag").remove();Store.isOpenInfo=false},loadTagListData:function(){var the=this;$.ajax({url:APIConfig.base+APIConfig.list.tags,type:"GET",dataType:"jsonp",data:{aid:aid,jsonp:"jsonp"},xhrFields:{withCredentials:true},success:function(data){if(data.code===0){Store.tagList=data.data||[];Store.tagList.reverse();the.createTagList();the.state.isFirst=true;the.domLink.show();the.domNothing.hide()}if(data.code===16006){}}})},hasTag:function(name){for(var i=0;i<Store.tagList.length;i++){if(Store.tagList[i].tag_name===name){return false}}return true},addTag:function(){var the=this;var ipt=this.domIpt.find("input");var str=$.trim(ipt.val());if(str.length>20){return false}if(str&&Tools.filterString(str)){if(this.hasTag(str)){$.ajax({url:APIConfig.base+APIConfig.list.add,type:"POST",dataType:"json",xhrFields:{withCredentials:true},data:{aid:aid,tag_name:str,jsonp:"jsonp"},success:function(data){if(data.code===61001||data.code===61002){$.getScript("//static.hdslb.com/common/js/identityDialog.js",function(){IdentityDialog(data.code,data.message)});return}if(data.code===0){the.switchInputState();Store.tagList.unshift({tag_id:data.tid,tag_name:str,cover:"",content:"",likes:0,hates:0,is_atten:0,attribute:0,type:0,ctime:0,state:0,count:{view:0,use:0,atten:0}});the.createTagList();the.tagEventBind()}else{(new MessageBox).show(ipt,data.message,Store.msgTime,"error")}}})}else{(new MessageBox).show(ipt,"该标签已存在",Store.msgTime,"error")}}else{(new MessageBox).show(ipt,"输入内容为空或含非法字符",Store.msgTime,"error")}},domRender:function(){this.container.find(".tag-list").remove();this.setLogUrl();this.domUl.prependTo(this.container);this.domLink.appendTo(this.container);this.domNothing.prependTo(this.domUl);this.domBtnAdd.appendTo(this.domUl);this.domIpt.appendTo(this.domUl);this.bindUI()},setLogUrl:function(){var title=$(".v-title h1").attr("title");this.domLink.find(".btn-view-mod").attr("href","//www.bilibili.com/taglog#aid="+aid+"&title="+encodeURI(title));this.domLink.find(".btn-view-user").attr("href","//www.bilibili.com/html/help.html#s")},bindUI:function(){var the=this;this.domBtnAdd.off("click").click(function(e){TagAdmin.add(function(){if(!Store.isOpenInfo)the.switchInputState()},$(this));e.stopPropagation();customReport("playpage_tag_build")});this.domIpt.find(".btn-close").off("click").click(function(){the.switchInputState()});this.domIpt.off("click,input").on("click","input",function(e){e.stopPropagation()}).on("input","input",function(e){if($(this).val().length>20){the.domIpt.find(".tips").show()}else{the.domIpt.find(".tips").hide()}});$(document).off("keydown").on("keydown",function(e){if(e.keyCode===13&&the.state.isInput){the.addTag()}});$(document).off("click").on("click",function(e){if(the.state.isInput){the.switchInputState()}});this.tagEventBind()},tagEventBind:function(){var the=this;this.domUl.off("mouseenter").on("mouseenter",".tag",function(){if(Store.isOpenInfo)return;Store.isOver=true;$(this)[0].isOver=true;var that=$(this);setTimeout(function(){if(that[0].isOver){var index=that.attr("data-index");Store.currentIndex=index;the.state.currentTag=that;Store.tagList[index]["x"]=that.offset().left;Store.tagList[index]["y"]=that.offset().top+that.height()+6;Store.tagList[index]["index"]=index;TagPanel.show(Store.tagList[index])}},300)});this.domUl.off("mouseleave").on("mouseleave",".tag",function(e){if(Store.isOpenInfo)return;Store.isOver=false;$(this)[0].isOver=false;setTimeout(function(){if(!Store.isOver)TagPanel.remove()},300)});this.domUl.off("click.domul").on("click.domul",".tag",function(e){customReport("tag_click",$(this).data("tagid"))})},switchInputState:function(){var the=this;this.state.isInput=!this.state.isInput;if(this.state.isInput){this.domBtnAdd.hide();this.domIpt.css({display:"block"}).animate({opacity:1,width:158})}else{this.domIpt.find("input").val("");this.domIpt.animate({width:23},function(){$(this).css({display:"none"});the.domBtnAdd.fadeIn(100)});this.domIpt.find(".tips").hide()}},delTag:function(index){var the=this;this.domUl.find(".tag[data-index="+Store.currentIndex+"]").fadeOut(500,function(){Store.tagList.splice(Store.currentIndex,1);Store.isOpenInfo=false;the.state.isFirst=false;the.createTagList();the.tagEventBind();if(Store.tagList.length>0){the.domLink.show();the.domNothing.hide()}else{the.domNothing.show();the.domLink.hide()}})},getCurrentTag:function(){return this.state.currentTag},init:function(){this.domRender();this.loadTagListData()}};var TagPanel={isRemove:false,panel:null,delPanel:null,reportPanel:null,state:{reportType:null},domBox:"<div data-index={index} class='tag-info-pane' style='left:{x}px;top:{y}px'>"+"<div class='tag-header clearfix'>"+"<div class='tag-title'><a href='//www.bilibili.com/tag/{tag_id}/?pagetype=videopage' target='_blank'>{tag_name}</a></div>"+"<a class='btn-sub btn-subscribe'>+ 关注</a>"+"<a class='btn-sub btn-unsubscribe'>已关注</a>"+"</div>"+"<div class='btn-right-box'>"+"<a class='btn-crown'><i></i>顶 <span>{likesd}</span></a>"+"<a class='btn-tread'><i></i>踩 <span>{hatesd}</span></a>"+"</div>"+"<div class='text'>{content}</div>"+"<div class='tag-footer clearfix'>"+"<div class='btn-left-box'>"+"<a class='btn-close'>删除</a>"+"<a class='btn-report'>举报</a>"+"</div>"+"</div>"+"</div>",domDelPopup:"<div class='tag-del-popup'><p>确定要删除该标签吗？</p><a class='btn-ok'>确定</a><a class='btn-no'>取消</a></div>",domReportPopup:"<div class='tag-report-popup'>"+"<h3>请输入举报理由</h3>"+"<ul><li data-type='内容不相关'><i></i>内容不相关</li><li data-type='敏感信息'><i></i>敏感信息</li><li data-type='恶意攻击'><i></i>恶意攻击</li><li data-type='剧透内容'><i></i>剧透内容</li></ul>"+"<a class='btn-ok'>确定</a><a class='btn-close'></a>"+"</div>",show:function(data){var the=this;this.remove();data.likesd=this.yw(data.likes);data.hatesd=this.yw(data.hates);if(data.likes===0)data.likesd="";if(data.hates===0)data.hatesd="";this.panel=$(Tools.substitute(this.domBox,data)).css({display:"none"});this.setState(data);this.bindUI();this.panel.appendTo("body").fadeIn();customReport("playpage_tag")},yw:function(x){if(x>=1e8){return parseFloat(x/1e8).toFixed(1)+"亿"}else if(x>=1e4){return parseFloat(x/1e4).toFixed(1)+"万"}else{return x}},setState:function(data){if(!this.panel.find(".text").text())this.panel.find(".text").remove();this.switchSubscribeState(data.is_atten);if(UserStatus.isLogin()){if(TagAdmin.isUp())return;if(UserStatus.level()<Level.l1||Store.tagList[Store.currentIndex]["attribute"]){this.panel.find(".btn-close").addClass("the-grey")}}if(UserStatus.isLogin()){if(TagAdmin.isUp())return;if(UserStatus.level()<Level.l4){this.panel.find(".btn-report").addClass("the-grey");this.panel.find(".btn-crown").addClass("the-grey");this.panel.find(".btn-tread").addClass("the-grey")}}},bindUI:function(){var the=this;this.panel.find(".btn-subscribe").off("click").on("click",function(){var that=this;var index=Store.currentIndex;TagAdmin.todo(function(){$.ajax({url:APIConfig.base+APIConfig.list.subscribe,type:"POST",dataType:"json",xhrFields:{withCredentials:true},data:{tag_id:Store.tagList[Store.currentIndex]["tag_id"],jsonp:"jsonp"},success:function(data){if(data.code===0){the.switchSubscribeState(true);Store.tagList[index].is_atten=1}else{(new MessageBox).show($(that),data.message,Store.msgTime,"error")}}})});customReport("playpage_tag_follow")});this.panel.find(".btn-unsubscribe").off("click").on("click",function(){var that=this;var index=Store.currentIndex;TagAdmin.todo(function(){$.ajax({url:APIConfig.base+APIConfig.list.unsubscribe,type:"POST",dataType:"json",xhrFields:{withCredentials:true},data:{tag_id:Store.tagList[Store.currentIndex]["tag_id"],jsonp:"jsonp"},success:function(data){if(data.code===0){the.switchSubscribeState(false);Store.tagList[index].is_atten=0}else{(new MessageBox).show($(that),data.message,Store.msgTime,"error")}}})});customReport("playpage_tag_unfollow")});this.panel.find(".btn-unsubscribe").off("mouseover,mouseout").on({mouseover:function(){$(this).text("取消关注")},mouseout:function(){$(this).text("已关注")}});this.panel.find(".btn-close").off("click").on("click",function(){var index=Store.currentIndex;var x=$(this).offset().left-60;var y=$(this).offset().top-115;TagAdmin.del(function(){the.showDelPopup(x,y)},$(this))});this.panel.off("mouseleave").on("mouseleave",function(e){if(!the.isRemove){the.remove();Store.isOver=false}});this.panel.off("mouseenter").on("mouseenter",function(e){Store.isOver=true});this.panel.find(".btn-report").off("click").on("click",function(){var x=TagArea.getCurrentTag().offset().left;var y=TagArea.getCurrentTag().offset().top+28;TagAdmin.report(function(){the.showReportPopup(x,y)},$(this))});this.panel.find(".btn-crown").off("click").on("click",function(){var that=this;var index=Store.currentIndex;var span=$(this).find("span");var number=Number(span.text());TagAdmin.topOrTread(function(){$.ajax({url:APIConfig.base+APIConfig.list.like,type:"POST",dataType:"json",xhrFields:{withCredentials:true},data:{tag_id:Store.tagList[Store.currentIndex]["tag_id"],aid:aid,jsonp:"jsonp"},success:function(data){if(data.code===0){if(Store.tagList[index].liked==1){Store.tagList[index].likes=Store.tagList[index].likes-1;Store.tagList[index].liked=0}else{Store.tagList[index].likes=Store.tagList[index].likes+1;Store.tagList[index].liked=1}Store.tagList[index].likesd=the.yw(Store.tagList[index].likes);span.text(Store.tagList[index].likesd?Store.tagList[index].likesd:"");Praise.show($(that),1,Store.tagList[index].liked);if(Store.tagList[index].hated===1){Store.tagList[index].hates=Store.tagList[index].hates-1;Store.tagList[index].hatesd=the.yw(Store.tagList[index].hates)?the.yw(Store.tagList[index].hates):"";$(the.panel.find(".btn-tread span")).text(Store.tagList[index].hatesd);Praise.show($(the.panel.find(".btn-tread")),1,false);Store.tagList[index].hated=0}}else{(new MessageBox).show($(that),data.message,Store.msgTime,"error")}}})},$(this))});this.panel.find(".btn-tread").off("click").on("click",function(){var that=this;var index=Store.currentIndex;var span=$(this).find("span");var number=Number(span.text());TagAdmin.topOrTread(function(){$.ajax({url:APIConfig.base+APIConfig.list.hate,type:"POST",dataType:"json",xhrFields:{withCredentials:true},data:{tag_id:Store.tagList[Store.currentIndex]["tag_id"],aid:aid,jsonp:"jsonp"},success:function(data){if(data.code===0){if(Store.tagList[index].hated==1){Store.tagList[index].hates=Store.tagList[index].hates-1;Store.tagList[index].hated=0}else{Store.tagList[index].hates=Store.tagList[index].hates+1;Store.tagList[index].hated=1}Store.tagList[index].hatesd=the.yw(Store.tagList[index].hates);span.text(Store.tagList[index].hatesd?Store.tagList[index].hatesd:"");Praise.show($(that),1,Store.tagList[index].hated);if(Store.tagList[index].liked===1){Store.tagList[index].likes=Store.tagList[index].likes-1;Store.tagList[index].likesd=the.yw(Store.tagList[index].likes)?the.yw(Store.tagList[index].likes):"";$(the.panel.find(".btn-crown span")).text(Store.tagList[index].likesd);Praise.show($(the.panel.find(".btn-crown")),1,false);Store.tagList[index].liked=0}}else{(new MessageBox).show($(that),data.message,Store.msgTime,"error")}}})},$(this))})},switchSubscribeState:function(boo){if(boo){this.panel.find(".btn-subscribe").hide();this.panel.find(".btn-unsubscribe").show()}else{this.panel.find(".btn-subscribe").show();this.panel.find(".btn-unsubscribe").hide()}},showDelPopup:function(x,y){var the=this;this.delPanel=$(this.domDelPopup);this.delPanel.css({left:x,top:y});$("body").append(this.delPanel);Store.isOpenInfo=true;this.delPanel.find(".btn-ok").off("click").on("click",function(){var that=this;$.ajax({url:APIConfig.base+APIConfig.list.del,type:"POST",dataType:"json",data:{aid:aid,tag_id:Store.tagList[Store.currentIndex]["tag_id"],jsonp:"jsonp"},xhrFields:{withCredentials:true},success:function(data){if(data.code===0){the.isRemove=false;the.delPanel.remove();the.remove();TagArea.delTag()}else{(new MessageBox).show($(that),data.message,Store.msgTime,"error")}}})});this.delPanel.find(".btn-no").off("click").on("click",function(e){the.isRemove=false;the.delPanel.remove();Store.isOpenInfo=false});this.isRemove=true},showReportPopup:function(x,y){var the=this;this.state.reportType=null;this.reportPanel=$(this.domReportPopup);this.reportPanel.css({left:x,top:y});$("body").append(this.reportPanel);Store.isOpenInfo=true;this.reportPanel.find("li").off("click").on("click",function(){$(this).addClass("on").siblings("li").removeClass("on");the.state.reportType=$(this).attr("data-type")});var msg;this.reportPanel.find(".btn-ok").off("click").on("click",function(){var that=this;if(the.state.reportType){$.ajax({url:APIConfig.base+APIConfig.list.report,type:"POST",dataType:"json",xhrFields:{withCredentials:true},data:{aid:aid,tag_id:Store.tagList[Store.currentIndex]["tag_id"],reason:the.state.reportType,jsonp:"jsonp"},success:function(data){if(data.code===0){the.reportPanel.find(".btn-close").click();if(msg){msg.close()}(new MessageBox).show(TagArea.getCurrentTag(),"已提交举报",Store.msgTime,"info")}else{if(msg){msg.close()}(new MessageBox).show($(that),data.message,Store.msgTime,"error")}}})}else{msg=new MessageBox;msg.show($(that),"请选择举报原因",Store.msgTime,"info")}});this.reportPanel.find(".btn-close").off("click").on("click",function(){the.reportPanel.remove();Store.isOpenInfo=false});this.remove()},remove:function(){if(this.panel){this.panel.animate({opacity:0},function(){$(this).remove()})}}};var Praise={show:function(obj,number,boo){var temp=$("<div class='tag-praise'><div>");var the=this;var _x=$(obj).offset().left;var _y=$(obj).offset().top;var str=boo?"+"+number:"-"+number;var cla=boo?"plus":"reduce";temp.css({display:"block",left:_x,top:_y}).addClass(cla).text(str).appendTo("body");temp.animate({top:_y-18},function(){temp.fadeOut(function(){temp.remove()})})}};$(function(){TagArea.init()})})(jQuery);
